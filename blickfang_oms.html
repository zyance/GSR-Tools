<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>san.app – Adresse → GPS → OSM</title>

<!-- GOOGLE MAPS (NUR GEOCODING, KEINE KARTE) -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvgVofPZUbywEiHJzhXNujYTc0yQRJKeE&callback=initMap"
  defer>
</script>

<!-- LEAFLET / OSM -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  height: 100vh;
  display: flex;
}

.sidebar {
  width: 320px;
  padding: 16px;
  border-right: 1px solid #ccc;
  background: #f9f9f9;
}

.main {
  flex: 1;
  padding: 16px;
}

.view {
  width: 1600px;
  height: 1200px;
  border: 1px solid #999;
}

input, button {
  width: 100%;
  padding: 6px;
  margin-bottom: 8px;
}
</style>
</head>

<body>

<!-- =======================
     LINKS: ADRESSE + GPS
     ======================= -->
<div class="sidebar">
  <h3>Adresse (Wien)</h3>

  <div style="display:flex; gap:8px;">
    <input id="street" placeholder="Straße / Gasse" style="flex:3;">
    <input id="number" placeholder="Nr." style="flex:1;">
  </div>

  <button onclick="searchAddress()">Go</button>

  <h3>GPS</h3>
  <div style="display:flex; gap:8px;">
    <input id="lat" placeholder="Lat" readonly>
    <input id="lng" placeholder="Lng" readonly>
  </div>
</div>

<!-- =======================
     RECHTS: OSM KARTE
     ======================= -->
<div class="main">
  <div id="osmMap" class="view"></div>
</div>

<script>
/************************************************************
 *  OSM MAP – GRUNDLAGE
 ************************************************************/
const osmMap = L.map("osmMap").setView([48.2082, 16.3738], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(osmMap);

let buildingLayer = null;

/************************************************************
 *  ADRESSE → GPS (GOOGLE GEOCODING)
 ************************************************************/
function searchAddress() {

  if (!window.google || !google.maps) {
    alert("Google Maps API noch nicht geladen.");
    return;
  }

  const street = document.getElementById("street").value.trim();
  const number = document.getElementById("number").value.trim();

  if (!street || !number) {
    alert("Bitte Straße und Hausnummer eingeben.");
    return;
  }

  const address = `${street} ${number}, Wien, Österreich`;
  const geocoder = new google.maps.Geocoder();

  geocoder.geocode({ address }, function (results, status) {

    if (status !== "OK") {
      alert("Adresse nicht gefunden.");
      return;
    }

    const loc = results[0].geometry.location;
    const lat = loc.lat();
    const lng = loc.lng();

    document.getElementById("lat").value = lat.toFixed(6);
    document.getElementById("lng").value = lng.toFixed(6);

    osmMap.setView([lat, lng], 19);

    highlightBuilding(lat, lng);
  });
}

/************************************************************
 *  GEBÄUDE HERVORHEBEN (OSM / OVERPASS)
 ************************************************************/
async function highlightBuilding(lat, lng) {

  if (buildingLayer) {
    osmMap.removeLayer(buildingLayer);
    buildingLayer = null;
  }

  const maxRadius = 30;      // maximale Suche 30m
  const step = 5;            // Interpolationsschritt
  let foundElement = null;

  for (let radius = 5; radius <= maxRadius; radius += step) {

    const query = `
[out:json][timeout:25];
(
  way["building"](around:${radius}, ${lat}, ${lng});
  relation["building"](around:${radius}, ${lat}, ${lng});
);
out geom;
`;

    try {
      const response = await fetch(
        "https://overpass.kumi.systems/api/interpreter",
        {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "data=" + encodeURIComponent(query)
        }
      );

      const data = await response.json();

      if (data.elements && data.elements.length > 0) {
        foundElement = data.elements[0];
        console.log("Gebäude gefunden bei Radius:", radius);
        break; // STOP sobald erstes Gebäude gefunden
      }

    } catch (e) {
      console.warn("Overpass Fehler");
      return;
    }
  }

  if (!foundElement) {
    console.warn("Kein Gebäude im 30m Radius gefunden");
    return;
  }

  const geom = foundElement.geometry.map(p => [p.lat, p.lon]);

  buildingLayer = L.polygon(geom, {
    color: "#ff6600",
    weight: 2,
    fillOpacity: 0.15
  }).addTo(osmMap);
}
/************************************************************
 *  ADRESS-PUNKT (MARKER)
 *  - zeigt die exakte Adresse
 *  - wird bei jeder neuen Suche aktualisiert
 ************************************************************/
let addressMarker = null;

function highlightAddress(lat, lng) {

  // Alten Marker entfernen
  if (addressMarker) {
    osmMap.removeLayer(addressMarker);
    addressMarker = null;
  }

  // Neuer Marker (ruhig, sachlich)
  addressMarker = L.circleMarker([lat, lng], {
    radius: 6,
    color: "#0066cc",
    fillColor: "#0066cc",
    fillOpacity: 0.9
  }).addTo(osmMap);
}
</script>

</body>
</html>
